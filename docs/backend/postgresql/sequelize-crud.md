# Sequelize CRUD

This page of notes is simplified from [Sequelize Core Concepts - Model Instances](https://sequelize.org/master/manual/model-instances.html). Please read the Sequelize Documentations for more details.

- [API reference for Sequelize Model](https://sequelize.org/master/class/lib/model.js~Model.html)

## Pre-requisite
Assuming that you followed the notes in [Sequelize Basics](https://thoughtworks-sea.github.io/developer-training/#/backend/postgresql/sequelize-basics?id=create-a-simple-model), you should have created the `SimplePokemon` model for and acquired a database connection instance.

Alternatively, a model could be generated using `sequelize-cli`. This will generate different folder structure. However, [Migrations](https://sequelize.org/master/manual/migrations.html#project-bootstrapping) is another topic, which is recommended for production level software, however it requires manual configuration.
```sh
npx sequelize-cli init
npx sequelize-cli model:generate --name SimplePokemon --attributes name:string,japaneseName:string,baseHP:integer,category:string,nameWithJapanese:virtual
```
## Give it a try!

To explore Sequelize CRUD through the use of Sequelize Models, we could import the `SimplePokemon` model into "index.js".
```js
// index.js
import SimplePokemon from './db/models/simple-pokemon.model.js';
```

## Create

Although a model is an ES6 class, you should not create instances by using the `new` operator directly. Instead, Sequelize Model exposes 2 methods for specific process.
- [build](https://sequelize.org/master/class/lib/model.js~Model.html#static-method-build): class-level method to create an object that represents data that can be mapped to a database record. This is a synchronous method that does not communicate with the database at all.
- [save](https://sequelize.org/master/class/lib/model.js~Model.html#instance-method-save): instance-level method to save / persist the information into database. This is an asynchronous method, so you will need `await` or promise handling.

To facilitate the process, Sequelize Model offers another method to combines the above 2 into a single method.
- [create](https://sequelize.org/master/class/lib/model.js~Model.html#static-method-create): class-level method to create an object and save the database record. This is an asynchronous method, so you will need `await` or promise handling.

Use `create` to create a new instance and save the record into the database table `Simple_Pokemon`.

```js
  const pikachu = {
    name: "Pikachu",
    japaneseName: "ピカチュウ",
    baseHP: 35,
    category: "Mouse Pokemon",
  };
  const created = await SimplePokemon.create(pikachu);

  console.log('Pikachu was saved to the database!');
  console.log(created); // Not recommended, since Sequelize instances have a lot of things attached. This might produce a lot of clutter.
  console.log(created.toJSON()); // The recommended way to log an instance, but do note that this might still log sensitive data stored in database.
```

Upon a successful save, the result of the `create` method is a promise which resolves to the saved.

```json
{
    "nameWithJapanese": "Pikachu ピカチュウ",
    "id": 1,
    "name": "Pikachu",
    "japaneseName": "ピカチュウ",
    "baseHP": 35,
    "category": "Mouse Pokemon",
    "updatedAt": "2021-08-15T11:46:25.092Z",
    "createdAt": "2021-08-15T11:46:25.092Z"
}
```

Looking at the result, the following fields are returned in addition to the attributes that we've defined in the model and the information we passing in.
The additional fields are generated by Sequelize.
- `id`: Primary Key generated by Sequelize, if Primary Key is not defined.
- `createdAt`, `updatedAt`: This timestamp generated by Sequelize (by default) which could be turn off.

If you try to create another pokemon with the same `id` value,
```js
// Run this code after creation of pickachu.
  const pikachu2 = {
    id: 1,
    ...pikachu,
  }
  const created2 = await SimplePokemon.create(pikachu2)
  console.log(created2.toJSON());
```

you will find the application is hitting an error `UniqueConstraintError [SequelizeUniqueConstraintError]`.
```sh
  UniqueConstraintError [SequelizeUniqueConstraintError]: Validation error
  ...
  fields: { id: '1' },
  parent: error: duplicate key value violates unique constraint "Simple_Pokemon_pkey"
```

Change `id` to 2 and restart your application. You will find 2 identical pokemons in the database table `Simple_Pokemons` (both are having same attributes). This is because we didn't add any unique constraint onto the name column.

Let's try to update our model slightly.
1. Following the notes in [Sequelize Basics - More about Model Definition](backend/postgresql/sequelize-basics?id=more-about-model-definition).
In the example, we will add an unique index to the `name` field. Let's restart your application with the codes above to create 2 pokemons named `pikachu` with differrent `id`. What do you find?
1. Next, we explore [field validation](backend/postgresql/sequelize-basics?id=sequelize-validation) done by Sequelize.

## (WIP ?) Read

The returned result will be similar to what was displayed when we created the record. It is an instance of Sequelize Model.

### (WIP ?) FindAll

`findAll()` is the the main way we query the database with sequelize. The first parameter of find is a **options** object. Refer to the [API Reference](https://sequelize.org/master/class/lib/model.js~Model.html#static-method-findAll) for the list of supported options. If an empty object is passed or nothing is passed, then it will return all records.

Some notable options are grouped into:
- options for usual SQL query syntax
  - `where`
  - `order`
  - `having`
- additional options provided by Sequelize and translated into SQL query syntax
  - `attributes`
  - `include`: for list of associations to eagerly load using a left join.
  - `limit` and `offset`: for paginated result
  - `transaction`
  - `raw`: If true, sequelize will not try to format the results of the query, or build an instance of a model from the result. You are responsible to build the model.
  - `searchPath`: An optional parameter (string) to specify the [schema search_path (Postgres only)](https://www.postgresql.org/docs/current/ddl-schemas.html#DDL-SCHEMAS-PATH)
  - `rejectOnEmpty`: Throws an error when no records found. **Default: false**
- others (eg. for performance analysis)
  - `logging`
  - `benchmark`

```js
await SimplePokemon.create([
  {
    name: "Pikachu",
    japaneseName: "ピカチュウ",
    baseHP: 35,
    category: "Mouse Pokemon",
  },
  {
    name: "Squirtle",
    japaneseName: "ゼニガメ",
    baseHP: 44,
    category: "Tiny Turtle Pokemon",
  },
  {
    name: "Wartortle",
    japaneseName: "カメール",
    baseHP: 59,
    category: "Turtle Pokémon",
  },
  {
    name: "Meowth",
    japaneseName: "ニャース",
    baseHP: 40,
    category: "Scratch Cat Pokémon",
  },
]);

const foundPokemons = await SimplePokemon.findAll();
return foundPokemons;
```

#### (WIP ?) Raw Query

??? find() returns a query. ??? queries are not promises. They have a `then()` function so that they can be used with async/await. However, unlike promises, calling a query's then() can execute the query multiple times.

[Read more about raw queries here](https://sequelize.org/master/manual/raw-queries.html).

```js
const query = SimplePokemon.find();
query instanceof ??? ; // true

// Execute the query
const pokemons = await query;
```

#### (WIP ?) basic filter

You can filter through Pokemon by their attributes, using `where`.

For example, to find all instances where `category` == "Mouse Pokemon":

```js
const filteredPokemons = await SimplePokemon.findAll({
  where: { category: "Mouse Pokemon" },
});
```

Or to find 1 instance where `name` == "Pikachu":

```js
const filteredPokemons = await SimplePokemon.findOne({
  where: { name: "Pikachu" },
});
```

### (WIP ?) Query operator

https://sequelize.org/master/manual/model-querying-basics.html#postgres-only-range-operators
https://sequelize.org/master/manual/model-querying-basics.html#operators

We can use comparison operators `$lt`, `$gt`, `$lte`, and `$gte`

Less than:

```js
const filterHPGreaterThan = async (HP) => {
  const filteredPokemons = await SimplePokemon.find({
    baseHP: { $gt: HP },
  });
  return filteredPokemons;
};

filterHPGreaterThan(40).then((data) => {
  console.log(`filterHPGreaterThan: ${data}`);
});
```

Now try to use `$lte` with a string. Strings will be compared using their unicode.

How do you sort the results?

#### (WIP ?) Regular expression

Suppose you want to find characters whose rank contains 'turtle'. In SQL, you would use the LIKE operator. In Sequelize, you can simply query with a [powerful `where` clause](https://sequelize.org/master/manual/model-querying-basics.html#applying-where-clauses).

```js
const filterByCategory = async (category) => {
  const regex = new RegExp(category, "gi");
  const filteredPokemons = await SimplePokemon.find({ category: regex });
  return filteredPokemons;
};

filterByCategory("turtle").then((pokemons) => {
  console.log(`filterByCategory: ${pokemons}`);

  // ??? Sequelize may return the pokemons in any order unless you explicitly sort
  pokemons.map((pokemon) => pokemon.name).sort();
});
```

```js
const pokemons = await SimplePokemon.find({
  category: { $eq: /turtle/ },
});
```

#### (WIP ?) multiple filter

Match multiple filter properties (AND)

```js
import { Op } from 'sequelize';

const pokemons = await SimplePokemon.findAll({
  where: {
    baseHP: { 
      [Op.gte]: 39
    },
    category: {
      [Op.regexp]: '/turtle/'
    }
  }
});

pokemons.map((pokemon) => pokemon.name);
```

### (WIP ??) Find One

https://sequelize.org/master/manual/model-querying-finders.html

```js
const pokemon = await SimplePokemon.findOne();

pokemon instanceof SimplePokemon; // true
pokemon instanceof sequelize.Model; // true
```

```js
const findOneByName = async (name) => {
  const foundPokemon = await SimplePokemon.findOne({ where: { name: 'Pikachu' } });
  return foundPokemon;
};
```

## (WIP ?) Update

The model static method `update()` update multiple instances that match the where options.

```js
const pikachu = {
  name: "Pikachu",
  japaneseName: "ピカチュウ",
  baseHP: 35,
  category: "Mouse Pokemon",
};
const created = await SimplePokemon.create(pikachu);
console.log(created.toJSON());

// Change baseHP for Pokemon(s) with a name "Pikachu"
const updated = await SimplePokemon.update({ baseHP: 40 }, {
  where: {
    name: "Pikachu"
  }
});
console.log(updated.toJSON());
```

- **TODO**: How to update just One ? Need to invoke [count()](https://sequelize.org/master/class/lib/model.js~Model.html#static-method-count) and validate first ?
- Try running Sequelize with debug logging to see what queries Sequelize executes.

### update(), upsert() vs save()

**TODO**
- `async update()` (Class-level): Update multiple instances that match the where options. Each row is subject to validation before it is inserted. The whole insert will fail if one row fails validation.
- `async upsert()` (Instance-level): This is the same as calling `set()` and then calling `save()` but it only saves the exact values passed to it, making it more atomic and safer.
- `async upsert()` (Class-level): Insert or update a single row. An update will be executed if a row which matches the supplied values on either the primary key or a unique key is found. Requires the unique index to be defined in sequelize model as well as the database table. Run validations before the row is inserted.
- `async save()` (Instance-level): Validates this instance, and if the validation passes, persists it to the database. This method is optimized to perform an UPDATE only when the fields have changed. If nothing has changed, no SQL query will be performed. This method is not aware of eager loaded associations.
- `set()` (Instance-level): Set is used to update values on the instance (the sequelize representation of the instance that is, remember that nothing will be persisted before you actually call save).

## (WIP ?) Delete

```js
const deleteOneById = async (id) => {
  try {
    await SimplePokemon.findByIdAndDelete(id);
  } catch (err) {
    handleError(err);
  }
};

const deleteAll = async () => {
  try {
    await SimplePokemon.deleteMany();
  } catch (err) {
    handleError(err);
  }
};
```

## (WIP ??) What is atomicity?

Optimistic Locking? - to confirm : https://sequelize.org/master/manual/optimistic-locking.html

An atomic operation is an operation that ensures whatever it is editing is only currently edited by the operation. When you want to update a database record, atomicity means that the database record is locked (not available to other operations) until the database record is updated.

If we do not have atomicity and there are 2 operations to be runs at the same time (concurrent calls),
1. Update pokemon1 baseHP++
2. Update pokemon1 baseHP++
Both operations will find a pokemon with baseHP that is 4, then both will add 1 to `baseHP = 4` and update the baseHP of the same pokemon to `baseHP = 5`. The final baseHP will be 5 instead of 6.



Sequelize has built-in support for optimistic locking through a model instance version count.

Optimistic locking is **disabled by default** and can be enabled by setting the version property to true in a specific model definition or global model configuration. See model configuration for more details.

Optimistic locking allows concurrent access to model records for edits and prevents conflicts from overwriting data. It does this by checking whether another process has made changes to a record since it was read and throws an OptimisticLockError when a conflict is detected.

**To confirm**: Has Sequelize remove/change built-in Optimistic Locking from v5 to v6?
- https://sequelize.org/v5/manual/models-definition.html#optimistic-locking
- The `options.version` wasn't mentioned in API reference for both versions, but [v6 documentation is missing after movement](https://sequelize.org/master/manual/models-definition.html#configuration)

References:
- [`where(checkVersion: boolean)`](https://sequelize.org/master/class/lib/model.js~Model.html#instance-method-where)
  - **Upcoming**: How to use [`sequelize.where`](https://sequelize.org/master/manual/model-querying-basics.html#advanced-queries-with-functions--not-just-columns-)
- [Read Replication](https://sequelize.org/master/manual/read-replication.html)
