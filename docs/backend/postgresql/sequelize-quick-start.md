### Installation

Install Sequelize and Postgres-related packages

```
npm install pg pg-hstore sequelize
```

We will also make use of `sequelize-cli` to help us generate the template for our Sequelize setup and run database migration for us. See: [Sequelize Migration](https://sequelize.org/master/manual/migrations.html)

```
npm install sequelize-cli -D
```

### Sequelize Configuration for Migration and Application

A typical project which use `sequelize-cli` has four subdirectories: **config, migrations, models, and seeders**. See: [Project bootstraping](https://sequelize.org/master/manual/migrations.html#project-bootstrappAing).

For better code organisation, we will create a folder `config` to store all our configuration (including database) and maintain a folder `db` to store all the files generated by `sequelize-cli`.
We will also create the config file manually instead of using the sequelize-cli generator as we prefer a `.js` setup file instead of a `.json` file for the [dynamic configuration](https://sequelize.org/master/manual/migrations.html#dynamic-configuration). A .`js` file allows us to refer to environment variables.

For details, here are the explanation for the configuration file and generated files for `sequelize-cli`, following our recommended code organisation.

| Folder / File          | Type            | Migration<br>Usage | Application<br>Usage | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| :------------------- | :-------------- | :----------------- | :------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `config/database.js` | create manually | Yes                | Yes                  | For migration and application to connect to database.                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| `db/models`          | generated       | No                 | Yes                  | For application to create database tables. The boilerplate for these files are generated by commands `sequelize-cli model:generate`.<br><br>These files **need to be updated manually** to reflect our data models expectation.                                                                                                                                                                                                                                                                    |
| `db/migrations`      | generated       | Yes                | No                   | For migration to create the database tables and update the database columns. The boilerplate for these files are generated by commands `sequelize-cli model:generate` (for create) and `sequelize-cli migration:generate` (for update).<br><br>These files **need to be updated manually** to reflect our updated database table definition. Please see [Migration Skeleton](https://sequelize.org/master/manual/migrations.html#migration-skeleton) for how to define the files for actual usage. |
| `db/seeders`         | generated       | Yes                | No                   | For data migration, eg. populate database table with sample data or test data. The boilerplate for these files are generated by commands `sequelize-cli seed:generate`.<br><br>These files **need to be updated manually** to reflect our data models expectation.                                                                                                                                                                                                                                 |

**Let's begin our set up for Sequelize Migration (Database Table Definition) and Sequelize (App Usage)**

1. create the config folder in the root folder
2. create a database.js file with the content below in the config folder
3. replace the username and password with the credentials for your postgres server. For the sake of this course, we will use `postgres` as the migration user.
4. replace the database key with the database name you prefer

```js
// config/database.js

module.exports = {
  development: {
    // replace the `username` and `password` with the credentials for your postgres server
    username: "postgres",
    password: null,
    database: "database_development",
    host: "127.0.0.1",
    dialect: "postgres",
  },
  test: {
    // replace the `username` and `password` with the credentials for your postgres server
    username: "postgres",
    password: null,
    database: "database_test",
    host: "127.0.0.1",
    dialect: "postgres",
  },
  production: {
    username: process.env.PG_USER,
    password: process.env.PG_PASS,
    database: process.env.PG_DB_NAME,
    host: process.env.PG_HOST,
    port: process.env.PG_PORT,
    dialect: "postgres",
    dialectOptions: {
      ssl: {
        require: true,
        rejectUnauthorized: false,
      },
    },
  },
};
```

**Set up Sequelize directory config**

This file is not generated by default, it is used to pass arguments to the `sequelize-cli` to run database migrations. However, it's recommended to create this file as follows, in order to override the default path of sequelize folders to customize the folder hierarchies. Having this configuration documented is useful when maintaining a shared codebase.

Steps:

1. Create an empty `.sequelizerc` file at the project root directory
2. Copy the following code for the recommended code organisation.

<!-- prettier-ignore -->
```js
// .sequelizerc

const path = require("path");

module.exports = {
  "config": path.resolve("config", "database.js"),
  "models-path": path.resolve("db", "models"),
  "seeders-path": path.resolve("db", "seeders"),
  "migrations-path": path.resolve("db", "migrations"),
};
```

**Create the database using Sequelize CLI**

In this example, we are using `npx` to run sequelize-cli's `sequelize` package with the command `db:create`.
Without `npx`, you will need to refer to the full node_modules path when running any commands from the sequelize-cli package

Let's create a database in the development environment with the name stated in the config file:

```
npx sequelize db:create
```

- By default, the command will run against the development environment.
- To change the environment to run against, prepend the NODE_ENV to the command. E.g. `NODE_ENV=test npx sequelize db:create`

If it says `permission denied`, you may need to alter the role of the postgres user that you are using `ALTER USER <username> SUPERUSER`, for example:

```
$ psql

// check list of roles and their permissions
// the default user on your machine will already have all the Superuser permissions by default
user=# \du

List of roles
    Role name    |                         Attributes                         | Member of
-----------------+------------------------------------------------------------+-----------
 postgres        |                                                            | {}
 sabrina         | Superuser, Create role, Create DB, Replication, Bypass RLS | {}

// make user "postgres" a superuser
user=# ALTER USER postgres SUPERUSER;
ALTER ROLE

user=# \du

List of roles
    Role name    |                         Attributes                         | Member of
-----------------+------------------------------------------------------------+-----------
 postgres        | Superuser                                                  | {}
 sabrina         | Superuser, Create role, Create DB, Replication, Bypass RLS | {}
```

**Initialize Folders for Sequelize CLI**

These commands will generate the folder, based on your `.sequelizerc` configuration.

```bash
# To store database migration scripts
npx sequelize init:migrations

# To store models definition, and index.js for model reference in the application.
npx sequelize init:models
```

Some other sequelize init commands that you can run (**we will skip these**, because we already manually created our config file, and are not looking to seed any data):

```
npx sequelize init:config
npx sequelize init:seeders
```

Once you are done with this step, a file `db/models/index.js` will be automatically generated to initialise all the models during NodeJS application start up.
You could access the following through the `db` variable exported from the boilerplate codes in `db/models/index.js`. (more on this later when we utilise it in our routes)

At the point of writing, the data models generated need some manual fix for undefined variable `Sequelize` (default export) vs `DataTypes` (named export) which are exported from `sequelize` module.
You will need to adjust the models, migration and seeding scripts to fit your needs. See: [Query Interface](https://sequelize.org/master/class/lib/dialects/abstract/query-interface.js~QueryInterface.html).

### Create a model

Run this command in the terminal:

```bash
npx sequelize model:generate --name Pokemon --attributes name:string
```

This generation script will create 2 files with all the boilerplate, so you don't have to code it from scratch:

- a model class file
- a migration file

```bash
New model was created at xyz/db/models/pokemon.js .
New migration was created at xyz/db/migrations/20210823035441-create-pokemon.js .
```

You may go ahead and add more fields for your Pokemon model, and add any constraints if necessary. For example:

```js
"use strict";
const { Model } = require("sequelize");

module.exports = (sequelize, DataTypes) => {
  class Pokemon extends Model {
  ...
  Pokemon.init(
    {
      name: {
        type: DataTypes.STRING,
        allowNull: false, // ensures it is not null
        unique: true, // ensures uniqueness
      },
      japaneseName: {
        type: DataTypes.STRING,
      },
      baseHP: {
        type: DataTypes.INTEGER,
      },
      ...
    },
    {
      sequelize,
      modelName: "Pokemon",
    }
  );
  return Pokemon;
};
```

If you do update the model definitions, you will need to update your migration file to keep them in sync:

```js
"use strict";
module.exports = {
  up: async (queryInterface, Sequelize) => {
    await queryInterface.createTable("Pokemons", {
      id: {
        allowNull: false,
        autoIncrement: true,
        primaryKey: true,
        type: Sequelize.INTEGER,
      },
      name: { // update this to match your model definitions for Pokemon
        allowNull: false,
        unique: true,
        type: Sequelize.STRING,
      },
      ...
    });
  },
  down: async (queryInterface, Sequelize) => {
    await queryInterface.dropTable("Pokemons");
  },
};
```

### Running the migration file

Important difference between migrations and models

- Migrations help keep track of the changes
- Running migrations will make the changes to the database directly
- Models represent the database tables by mapping it into an object we can refer to in the codebase

Run this command to create the Pokemon table in your database
`npx sequelize db:migrate`

- Running this command multiple times will not cause any conflicts as it will only run new migration files once
- Sequelize knows which migration files are new as it keeps track of database states with the metadata captured from each migration

**A Tip for migration is to always make sure changes to a database state can be undo and redo without breaking anything**

So it is a good practice to try the rollback/undo script when testing your migration scripts

```
npx sequelize db:migrate
npx sequelize db:migrate:undo
npx sequelize db:migrate
```

### Connect and initialise database for the main app

app.js

```js
const express = require("express");
const db = require("./db/models/index");
const app = express();

// sync will make sure the that the database is connected and the models are properly setup on app startup
db.sequelize.sync();

app.use(express.json());

module.exports = app;
```

### Create your routes

To access the database, you can do `db.ModelName`.

For example, in here we are trying to access the Pokemon model from the database, so we do `db.Pokemon`:

```js
// pokemons.route.js
const db = require("../db/models/index");

// route to GET /pokemons
router.get("/", async (req, res, next) => {
  try {
    const pokemons = await db.Pokemon.findAll();

    res.json(pokemons);
  } catch (error) {
    next(error);
  }
});
```

For more querying methods, take a look at the Sequelize documentation [here](https://sequelize.org/master/manual/model-querying-basics.html)

For example, to find a Pokemon by their primary key id, you can do:

```js
const pokemonId = req.params.id;
const pokemon = await db.Pokemon.findByPk(pokemonId);
```

## Typical Folder structure

The components could have their own `__test__` folders, nearest to the source code itself.
```
- package.json
- package-lock.json
- src
  - config
    - database.js
  - db
    - models
    - migrations
    - seeders
  - routes
    - __tests__
  - services
    - __tests__
  - utils
    - middlewares
    - utils.js
  - app.js
  - app.test.js
- __tests__
  - integration-tests
- index.js
```